<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>ARTSTATION Pointcloud Test</title>

	<link rel="stylesheet" type="text/css" href="SCRIPTS/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/font-awesome/css/all.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jstree/themes/mixed/style.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/Cesium/Widgets/CesiumWidget/CesiumWidget.css">

	<style>
		video {
			display:none;
		}
		.potree_container {
			z-index: 0;
			position: absolute; 
			width: 100%; 
			height: 100%; 
			left: 0px; 
			top: 0px; 
		}
		#cesiumContainer {
			position: absolute;
			width: 100%; 
			height: 100%; 
			background-color:black;
		}
		.cesium-widget-credits {
			display: none;
		}
		.ARTSTATION_ControlBtn {
			position:absolute;
			bottom:-1px;
			z-index:900;
			border-radius: 0 !important;
			outline: none !important;
			border: 1px solid black;
			cursor: pointer;
			font-size: 30px;
			background: #e2e2e2;
			transition: background 1s;
			text-align:center;
			height: 112px;
			width: 112px;
			display: none;
		}
		.ARTSTATION_ControlBtn:hover {
			background: #eaeaea;
		}
		.ARTSTATION_ControlBtn:active {
			background: #fff;
		}
		.ARTSTATION_LeftBtn {
			left: -1px;
		}
		.DollyZoomOut, .ARTSTATION_PauseBtn {
			margin-left: 111px;
		}
		.ARTSTATION_RightBtn {
			right: -1px;
		}
		.modal-backdrop {
			z-index: 950;
		}
		#ARTSTATION_ControlPanel {
			z-index: 999;
		}
		.annotation-label {
			text-transform: capitalize;
		}
		.annotation {
			margin-top: -20px;
    		margin-left: 13px;
		}
		.ARTSTATION_UserFeedback {
			position: absolute;
			left:0;
			right: 0;
			text-align: center;
			font-size: 35px;
			color: white;
			text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;  
			z-index: 999;
			display: none;
			text-transform: uppercase;
		}
		@media (min-width: 769px) {
			.ARTSTATION_UserFeedback {
				bottom: 10px;
			}
		}
		@media (max-width: 768px) {
			.ARTSTATION_UserFeedback {
				top: 10px;
			}
		}
	</style>
</head>

<body>
	<script src="SCRIPTS/jquery/jquery-3.1.1.min.js"></script>
	<script src="SCRIPTS/bootstrap/js/bootstrap.js"></script>
	<script src="SCRIPTS/localforage/localforage.js"></script>
	<script src="SCRIPTS/spectrum/spectrum.js"></script>
	<script src="SCRIPTS/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="SCRIPTS/jquery-ui/jquery-ui.min.js"></script>
	<script src="SCRIPTS/three.js/build/three.js"></script>
	<script src="SCRIPTS/other/BinaryHeap.js"></script>
	<script src="SCRIPTS/tween/Tween.js"></script>
	<script src="SCRIPTS/d3/d3.js"></script>
	<script src="SCRIPTS/proj4/proj4.js"></script>
	<script src="SCRIPTS/openlayers3/ol.js"></script>
	<script src="SCRIPTS/i18next/i18next.js"></script>
	<script src="SCRIPTS/jstree/jstree.js"></script>
	<script src="SCRIPTS/potree/potree.js"></script>
	<script src="SCRIPTS/plasio/js/laslaz.js"></script>
	<script src="SCRIPTS/Cesium/Cesium.js"></script>
	<script src="SCRIPTS/taylorc/geoutm.js"></script>
	<script src="SCRIPTS/mobile-detect/mobile-detect.js"></script>
	<script src="SCRIPTS/stats/stats.js"></script>
	<!--<script src="SCRIPTS/ARTSTATION/main.js"></script>-->

	<!-- ARTSTATION Camera Dolly Buttons -->
	<button class="ARTSTATION_ControlBtn ARTSTATION_LeftBtn DollyZoomIn OnlyInEnvironment" onmousedown="DollyZoomIn();" onmouseup="StopDollyZoom();" ontouchstart="DollyZoomIn();" ontouchend="StopDollyZoom();">
		<i class="fas fa-search-plus"></i>
	</button>
	<button class="ARTSTATION_ControlBtn ARTSTATION_LeftBtn DollyZoomOut OnlyInEnvironment" onmousedown="DollyZoomOut();" onmouseup="StopDollyZoom();" ontouchstart="DollyZoomOut();" ontouchend="StopDollyZoom();">
		<i class="fas fa-search-minus"></i>
	</button>

	<!-- ARTSTATION Home Button -->
	<button class="ARTSTATION_ControlBtn ARTSTATION_RightBtn ARTSTATION_HomeBtn OnlyInEnvironment" onclick="ReturnToWorldView();">
		<i class="fas fa-home"></i>
	</button>

	<!-- ARTSTATION Video Controls -->
	<button class="ARTSTATION_ControlBtn ARTSTATION_LeftBtn ARTSTATION_PlayBtn OnlyInVideo" onclick="playCurrentVideo();">
		<i class="fas fa-play"></i>
	</button>
	<button class="ARTSTATION_ControlBtn ARTSTATION_LeftBtn ARTSTATION_PauseBtn OnlyInVideo" onclick="pauseCurrentVideo();">
		<i class="fas fa-pause"></i>
	</button>

	<!-- ARTSTATION Exit Video -->
	<button class="ARTSTATION_ControlBtn ARTSTATION_RightBtn ARTSTATION_ExitBtn OnlyInVideo" onclick="exitCurrentVideo();">
		<i class="fas fa-times"></i>
	</button>

	<!-- ARTSTATION User Feedback -->
	<span class="ARTSTATION_UserFeedback"></span>

	<!-- ARTSTATION Controls Popup -->
	<div class="modal fade" id="ARTSTATION_ControlPanel">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">ARTSTATION Controls</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<ul class="ARTSTATION_DeviceControls">
						<li>Click on an environment to enter it.</li>
						<li>Double click within an environment to move.</li>
						<li>Use left mouse down to rotate camera.</li>
						<li>Zoom in/out with the buttons in the bottom left.</li>
						<li>Exit an environment with the button in the bottom right.</li>
					</ul>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ARTSTATION Render Area -->
	<div class="potree_container">
		<div id="potree_render_area">
			<div id="cesiumContainer"></div>			
		</div>
		<!--<div id="potree_sidebar_container"> </div>-->
	</div>	

	<script>
		//SHOW CONTROLS MODAL (WIP)
		$("#ARTSTATION_ControlPanel").modal("show");

		//DEFINE DATA STORES
		var VIDEO = [];
		var LOCATION = [];
		var DOLLY_COUNTER = [0,0];
		var LOADING_PROGRESS = 0;
		var CAMERA_UNLOCK_DATA = {yaw: 0, _pitch: 0, maxPitch: 0, minPitch: 0, radius: 0, pitch: 0, focusPoint: (0,0,0)};

		//DEFINE WORLD STATES
		var IN_WORLDVIEW = 0;
		var IN_ENVIRONMENT = 1;
		var IS_TRANSITIONING_TO_ENVIRONMENT = 2;
		var IS_TRACKING_VIDEO = 3;
		var IS_TRANSITIONING_TO_VIDEO = 4;
		var IS_TRANSITIONING_TO_WORLDVIEW = 5;
		var WORLD_STATE = null;

		//DEFINE FOCUSSED VIDEO STATES
		var REQUESTED_PAUSE = 0;
		var HAS_PAUSED = 1;
		var REQUESTED_PLAY = 2;
		var IS_PLAYING = 3;
		var REQUESTED_STOP = 4;
		var HAS_STOPPED = 5;
		var FOCUSSED_VIDEO_STATE = null;

		//DEFINE POTREE VIEWER
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"), {
			useDefaultRenderLoop: false
		});

		//CONFIGURE POTREE VIEWER PER DEVICE
		var device = new MobileDetect(window.navigator.userAgent);
		var OPTIMISATION_PointBudget = 1000000;
		var OPTIMISATION_MinNodeSize = 100;
		var OPTIMISATION_UseHQ = true;
		if (device.mobile() != null) {
			//Mobile device
			OPTIMISATION_MinNodeSize = 200;
			OPTIMISATION_UseHQ = false;
			OPTIMISATION_PointBudget = 100000; 
		}
		if (device.mobileGrade() != "A") {
			//Device is not A-Grade by jQuery standards
			OPTIMISATION_MinNodeSize = 300;
			OPTIMISATION_UseHQ = false;
			OPTIMISATION_PointBudget = 50000; 
		}
		viewer.setFOV(60);
		viewer.setPointBudget(OPTIMISATION_PointBudget); 
		viewer.setEDLEnabled(false);
		viewer.setBackground(null); 
		viewer.loadSettingsFromURL();
		//viewer.useHQ = OPTIMISATION_UseHQ;
		viewer.useHQ = false; //"ART STYLE" is squares, so HQ must be disabled.
		viewer.setMinNodeSize(OPTIMISATION_MinNodeSize);
		console.log("Optimisation result:\nPOINT BUDGET - " + OPTIMISATION_PointBudget + "\nMIN NODE SIZE - " + OPTIMISATION_MinNodeSize + "\nSHOULD USE HQ - " + OPTIMISATION_UseHQ);

		//UPDATE CONTROL LIST
		if (device.mobile() != null) {
			//Mobile
			$(".ARTSTATION_DeviceControls").html("<li>Touch on an environment to enter it.</li><li>Touch within an environment to move.</li><li>Touch and drag to rotate camera.</li><li>Zoom in/out with the buttons in the bottom left.</li><li>Exit an environment with the button in the bottom right.</li>");
		}
		else
		{
			//Desktop
			$(".ARTSTATION_DeviceControls").html("<li><b>Environments</b></li><ul><li>Click to enter from world view.</li><li>Double click to move focus.</li><li>Use left mouse down to rotate camera.</li><li>Zoom in/out with the buttons in the bottom left.</li><li>Exit with the button in the bottom right.</li></ul><li><b>Videos</b></li><ul><li>Click a video marker to play.</li><li>Play/pause with the buttons in the bottom left.</li><li>Exit with the button in the bottom right.</li></ul>");
		}

		//DEFINE CESIUM VIEWER
		window.cesiumViewer = new Cesium.Viewer('cesiumContainer', {
			useDefaultRenderLoop: false,
			animation: false,
			baseLayerPicker : false,
			fullscreenButton: false, 
			geocoder: false,
			homeButton: false,
			infoBox: false,
			sceneModePicker: false,
			selectionIndicator: false,
			timeline: false,
			navigationHelpButton: false,
			imageryProvider : Cesium.createOpenStreetMapImageryProvider({url : 'https://a.tile.openstreetmap.org/'}),
			//imageryProvider : Cesium.BingMapsImageryProvider({
			//	mapStyle: Cesium.BingMapsStyle.CANVAS_DARK,
			//	url : '//dev.virtualearth.net', 
			//}),
			terrainShadows: Cesium.ShadowMode.ENABLED,
			terrainProvider: Cesium.createWorldTerrain({
			    requestVertexNormals: true
			})
		});

		//CONFIGURE CESIUM VIEWER
		let cp = new Cesium.Cartesian3(4303414.154026048, 552161.235598733, 4660771.704035539);
		cesiumViewer.camera.setView({
			destination : cp,
			orientation: {
				heading : 10, 
				pitch : -Cesium.Math.PI_OVER_TWO * 0.5, 
				roll : 0.0 
			}
		});

		//SET INITIAL STATE
		setState(IN_WORLDVIEW, false);

		//SHOW DEBUG STATS
		var stats = new Stats();
		stats.showPanel(0);
		document.body.appendChild(stats.dom);

		/*
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
		});
		*/

		//LOAD FIELD
		loadLocation(
			"field", 
			50, 
			function(location) { 
				createVideo(location, "edited"); 
			}
		);

		//LOAD ST THOMAS HEAD
		loadLocation(
			"st_thomas_head", 
			45, 
			function(location) { 
				createVideo(location, "DJI_0023"); 
			}
		);


		//------------------------------------

		//RENDER LOOP
		function loop(timestamp){
			requestAnimationFrame(loop);
			stats.begin();
			if (WORLD_STATE == IN_WORLDVIEW || WORLD_STATE == IS_TRANSITIONING_TO_ENVIRONMENT) {
				$(".annotation").show();
			}
			else
			{
				$(".annotation").hide();
			}
			viewer.update(viewer.clock.getDelta(), timestamp);
			if(window.toMap !== undefined){
				{
					let camera = viewer.scene.getActiveCamera();

					let pPos = new THREE.Vector3(0, 0, 0).applyMatrix4(camera.matrixWorld);
					let pRight = new THREE.Vector3(600, 0, 0).applyMatrix4(camera.matrixWorld);
					let pUp = new THREE.Vector3(0, 600, 0).applyMatrix4(camera.matrixWorld);
					let pTarget = viewer.scene.view.getPivot();

					let toCes = (pos) => {
						let xy = [pos.x, pos.y];
						let height = pos.z;
						let deg = toMap.forward(xy);
						let cPos = Cesium.Cartesian3.fromDegrees(...deg, height);

						return cPos;
					};

					let cPos = toCes(pPos);
					let cUpTarget = toCes(pUp);
					let cTarget = toCes(pTarget);

					let cDir = Cesium.Cartesian3.subtract(cTarget, cPos, new Cesium.Cartesian3());
					let cUp = Cesium.Cartesian3.subtract(cUpTarget, cPos, new Cesium.Cartesian3());

					cDir = Cesium.Cartesian3.normalize(cDir, new Cesium.Cartesian3());
					cUp = Cesium.Cartesian3.normalize(cUp, new Cesium.Cartesian3());

					cesiumViewer.camera.setView({
						destination : cPos,
						orientation : {
							direction : cDir,
							up : cUp
						}
					});
				}

				let aspect = viewer.scene.getActiveCamera().aspect;
				if(aspect < 1){
					let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
					cesiumViewer.camera.frustum.fov = fovy;
				}else{
					let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
					let fovx = Math.atan(Math.tan(0.5 * fovy) * aspect) * 2
					cesiumViewer.camera.frustum.fov = fovx;
				}
			}
			cesiumViewer.render();
			viewer.render();
			stats.end();
		}
		requestAnimationFrame(loop);

		//LOAD LOCATION POINTCLOUD INTO VIEWER
		function loadLocation(locationName, zOffset=0, callback=function(){}) {
		        Potree.loadPointCloud("http://assets.artstation.mattfiler.co.uk/POINTCLOUDS/"+locationName+"/cloud.js", locationName, e => {
		                let pointcloud = e.pointcloud;
		                let material = pointcloud.material;

		                pointcloud.position.z = zOffset;

		                viewer.scene.addPointCloud(pointcloud);
		                material.pointColorType = Potree.PointColorType.RGB;
		                material.size = 1;
		                material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
		                //material.shape = Potree.PointShape.CIRCLE;
		                viewer.fitToScreen();

					    var location_data = {
					        Name: locationName,
					        UUID: pointcloud.uuid,
					        Z_Offset: zOffset
					    };
					    var location_data_length = LOCATION.push(location_data);

					    {
							let locationAnnotation = new Potree.Annotation({
								position: pointcloud.position,
								title: locationName.replace(/_/g, " "),
							});
							viewer.scene.annotations.add(locationAnnotation);
						}

						Potree.measureTimings = true;
						
						//Zone 30U covers most of England and Wales so we should be fine with this - geoutm.js can always calculate for us.
						let pointcloudProjection = "+proj=utm +zone=30 +ellps=GRS80 +datum=NAD83 +units=m +no_defs";
						let mapProjection = proj4.defs("WGS84");

						window.toMap = proj4(pointcloudProjection, mapProjection);
						window.toScene = proj4(mapProjection, pointcloudProjection);
						
						{
							let bb = viewer.getBoundingBox();

							let minWGS84 = proj4(pointcloudProjection, mapProjection, bb.min.toArray());
							let maxWGS84 = proj4(pointcloudProjection, mapProjection, bb.max.toArray());
						}

						callback(location_data_length - 1);
		        });
		}

		//CREATE A VIDEO IN WORLD
		function createVideo(locationIndex, videoName, videoThumbnail="replace_me.png") {
		    //CREATE VIDEO ELEMENT
		    var video_element = document.createElement("video");
		    video_element.src = "http://assets.artstation.mattfiler.co.uk/VIDEOS/"+LOCATION[locationIndex].Name+"/"+videoName+".mp4";
		    video_element.id = LOCATION[locationIndex].Name+"_"+videoName;
		    video_element.autoplay = false;
		    video_element.loop = true;
		    video_element.volume = 0;
		    video_element.muted = true;
		    video_element.crossOrigin = 'anonymous';
		    document.body.appendChild(video_element);

		    //CREATE VIDEO MESH
		    var video_plane = new THREE.PlaneGeometry(20, 12, 1, 1);
		    var video_elem = document.getElementById(LOCATION[locationIndex].Name+"_"+videoName);
		    var video_texture = new THREE.VideoTexture(video_elem);
		    video_texture.minFilter = THREE.LinearFilter;
		    video_texture.magFilter = THREE.LinearFilter;
		    video_texture.format = THREE.RGBFormat;
		    var video_material = new THREE.MeshLambertMaterial({color: 0xffffff, map: video_texture, transparent: true, opacity: 0});
		    var video_plane_mesh = new THREE.Mesh(video_plane, video_material);
		    video_plane_mesh.material.side = THREE.DoubleSide;
		    video_plane_mesh.name = "ARTSTATION_VideoPlane";
		    video_plane_mesh.position.x = 0;
		    video_plane_mesh.position.y = 0;
		    video_plane_mesh.position.z = 0;
		    video_plane_mesh.rotation.y = Math.PI / 2;
		    video_plane_mesh.rotation.z = Math.PI / 2;
		    video_plane_mesh.visible = false;
		    viewer.scene.scene.add(video_plane_mesh);

		    //CREATE MARKER MESH
		    var marker_geometry = new THREE.BoxGeometry(10, 10, 10);
		    var marker_texture = new THREE.TextureLoader().load("http://assets.artstation.mattfiler.co.uk/IMAGES/" + videoThumbnail);
		    marker_texture.crossOrigin = 'anonymous';
			var marker_material = new THREE.MeshBasicMaterial({color: 0xffffff, map: marker_texture, transparent: true, opacity: 0});
			var marker = new THREE.Mesh(marker_geometry, marker_material);
			marker.name = "ARTSTATION_VideoMarker";
		    viewer.scene.scene.add(marker);

		    //GET VIDEO POSITION DATA
		    var video_position_data = [];
		    var video_position_data_path = "API/gps_parser.php?location=" + LOCATION[locationIndex].Name + "&srt=" + videoName; //REMOTE
		    //var video_position_data_path = "API/gps_parser.json"; //LOCAL
		    $.getJSON(video_position_data_path, function(data) {
		        $.each(data, function(key, val) {
		            video_position_data.push(val);
		        });
		    });

		    //ADD VIDEO TO GLOBAL VIDEO ARRAY
		    var video_data = {
		        Name: videoName,
		        ElementID: LOCATION[locationIndex].Name+"_"+videoName,
		        LocationDataIndex: locationIndex, 
		        UUID: video_plane_mesh.uuid,
		        PositionArray: video_position_data,
		        LockCamera: false,
		        MarkerUUID: marker.uuid
		    };
		    var video_id = VIDEO.push(video_data);
		    video_id -= 1;

		    //MOVE VIDEO FROM GPS
		    moveVideoFromGPS(video_id);
		}

		//MOVE VIDEO ON TIME UPDATE FROM GPS DATA
		function moveVideoFromGPS(video_index) {
		    var major_time_milestone = 0;
		    var previous_acted_milestone = -1;
		    var camera_is_locked = false;
			var controls = viewer.getControls(viewer.scene.view.navigationMode);
		    $("#"+VIDEO[video_index].ElementID).on("timeupdate", function(event){
		        major_time_milestone = Math.floor(this.currentTime);
		        if (major_time_milestone != previous_acted_milestone) {
		            previous_acted_milestone = major_time_milestone;
		            try {
		                viewer.scene.scene.traverse((node) => {      
		                    if (node.uuid == VIDEO[video_index].UUID) {
		                        var new_position = new THREE.Vector3(
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][0], 
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][1], 
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][3]);
		                        var coords = ConvertToUTM(new_position.x, new_position.y);
		                        var VIDEO_NEW_POSITION = new THREE.Vector3(coords[0], coords[1], parseFloat(new_position.z) + 25 + LOCATION[VIDEO[video_index].LocationDataIndex].Z_Offset);

		                    	var VIDEO_TWEEN = new TWEEN.Tween(node.position).to(VIDEO_NEW_POSITION, 1000);
		                    	VIDEO_TWEEN.onStart(() => {
									//LOCK CAMERA TO VIDEO WHEN REQUESTED
			                    	if (VIDEO[video_index].LockCamera) {
										$(".annotation").hide();
			                    		controls.isTransitioning = true;
			                    		camera_is_locked = true;
			                    		setState(IS_TRACKING_VIDEO);

			                        	var CAMERA_NEW_POSITION = new THREE.Vector3(VIDEO_NEW_POSITION.x - 20, VIDEO_NEW_POSITION.y, VIDEO_NEW_POSITION.z);
			                        	
			                        	var CAMERA_TWEEN = new TWEEN.Tween(viewer.scene.view.position).to(CAMERA_NEW_POSITION, 1000);
										CAMERA_TWEEN.onUpdate(() => {
											viewer.scene.view.lookAt(node.position);
											if (FOCUSSED_VIDEO_STATE == REQUESTED_PAUSE) {
												VIDEO_TWEEN.pause();
												CAMERA_TWEEN.pause();
												FOCUSSED_VIDEO_STATE = HAS_PAUSED;
											}
											if (FOCUSSED_VIDEO_STATE == REQUESTED_PLAY) {
												VIDEO_TWEEN.play();
												CAMERA_TWEEN.play();
												FOCUSSED_VIDEO_STATE = IS_PLAYING;
											}
											if (FOCUSSED_VIDEO_STATE == REQUESTED_STOP) {
												/*
												VIDEO_TWEEN.stop();
												CAMERA_TWEEN.stop();
												*/
												FOCUSSED_VIDEO_STATE = HAS_STOPPED;
											}
										});
										CAMERA_TWEEN.onComplete(() => {
											if (!VIDEO[video_index].LockCamera && camera_is_locked) {
												viewer.scene.view.yaw = CAMERA_UNLOCK_DATA.yaw;
												viewer.scene.view._pitch = CAMERA_UNLOCK_DATA._pitch;
												viewer.scene.view.maxPitch = CAMERA_UNLOCK_DATA.maxPitch;
												viewer.scene.view.minPitch = CAMERA_UNLOCK_DATA.minPitch;
												viewer.scene.view.pitch = CAMERA_UNLOCK_DATA.pitch;
												viewer.scene.view.radius = CAMERA_UNLOCK_DATA.radius;

												var current_pointcloud = null;
												for (var i=0; i<viewer.scene.pointclouds.length;i++) {
													if (viewer.scene.pointclouds[i].uuid == controls.clickedEnvironmentUUID) {
														current_pointcloud = viewer.scene.pointclouds[i];
													}
												}

												controls.zoomToLocation({x:0,y:0}, false, 1000, true, function() {}, {
													distance: 100, 
													location: CAMERA_UNLOCK_DATA.focusPoint, 
													point: {position: CAMERA_UNLOCK_DATA.focusPoint}, 
													pointcloud: current_pointcloud
												});

												stopVideo(video_index);
												setState(IN_ENVIRONMENT);
												controls.isTransitioning = false;
												camera_is_locked = false;
											}
											else
											{
			                    				setState(IS_TRACKING_VIDEO);
												viewer.scene.view.lookAt(node.position);
											}
										});
										CAMERA_TWEEN.start();
			                    	}
								});
		                    	VIDEO_TWEEN.start();
		                    }
		                });
		            } catch { }
		        }
		    });
		}

		//HANDLE CLICK OR TOUCH
		$(document).on("click",function(event) {
			handleClickInput([event.clientX, event.clientY]);
		});
		$(document).on("touchstart", function(event){ 
			handleClickInput([event.originalEvent.touches[0].pageX, event.originalEvent.touches[0].pageY]);
		});
		var mouse = new THREE.Vector2();
		var controls = viewer.getControls(viewer.scene.view.navigationMode);
		function handleClickInput(position) {
			if (WORLD_STATE == IN_WORLDVIEW) {
				//MOVE TO LOCATION DEPENDING ON INPUT LOCATION
		        mouse.x = position[0];
		        mouse.y = position[1];
				controls.zoomToLocation(mouse, true, 600, true, function() {
					if (controls.didClickEnvironment) {
			        	controls.worldViewCameraConfig = false;

						setState(IN_ENVIRONMENT);
						userFeedbackPopup("Entering environment");

						for (var i = 0; i < VIDEO.length; i++) {
							if (LOCATION[VIDEO[i].LocationDataIndex].UUID == controls.clickedEnvironmentUUID) {
								try { viewer.scene.scene.traverse((node) => {
									if (node.uuid == VIDEO[i].MarkerUUID) {
										var marker_coords = ConvertToUTM(VIDEO[i].PositionArray[0][0], VIDEO[i].PositionArray[0][1]);
				                        var marker_position = new THREE.Vector3(marker_coords[0], marker_coords[1], parseFloat(VIDEO[i].PositionArray[0][3]) + 25 + LOCATION[VIDEO[i].LocationDataIndex].Z_Offset);
				                        node.position.x = marker_position.x;
				                        node.position.y = marker_position.y;
				                        node.position.z = marker_position.z;
    									node.visible = true;
		            					new TWEEN.Tween(node.material).to({opacity: 1}, 500).start();
				                    }
		                   		}); } catch { }
							}
						}
					}
				});
				if (controls.didClickEnvironment) {
					setState(IS_TRANSITIONING_TO_ENVIRONMENT);
					$(".annotation").fadeOut(600);
				}
			}
			if (WORLD_STATE == IN_ENVIRONMENT || WORLD_STATE == IS_TRACKING_VIDEO) {
				//MOVE TO VIDEO DEPENDING ON INPUT LOCATION
				mouse.x = ( position[0] / window.innerWidth ) * 2 - 1;
				mouse.y = - ( position[1] / window.innerHeight ) * 2 + 1;

				var raycaster = new THREE.Raycaster();
				raycaster.setFromCamera(mouse, viewer.scene.getActiveCamera());

				var video_planes = [];
				for (var i=0; i<viewer.scene.scene.children.length; i++) {
					if (viewer.scene.scene.children[i].name == "ARTSTATION_VideoMarker" ||
						viewer.scene.scene.children[i].name == "ARTSTATION_VideoPlane") {
						video_planes.push(viewer.scene.scene.children[i]);
					}
				}

				var intersects = raycaster.intersectObjects(video_planes);
				for (var i=0; i<intersects.length; i++) {
					for (var x=0; x<VIDEO.length;x++) {
						if (VIDEO[x].MarkerUUID == intersects[i].object.uuid) {
							if (VIDEO[x].LockCamera == false) {
								setState(IS_TRANSITIONING_TO_VIDEO);
								controls.isTransitioning = true;
								CAMERA_UNLOCK_DATA.yaw = viewer.scene.view.yaw;
								CAMERA_UNLOCK_DATA._pitch = viewer.scene.view._pitch;
								CAMERA_UNLOCK_DATA.maxPitch = viewer.scene.view.maxPitch;
								CAMERA_UNLOCK_DATA.minPitch = viewer.scene.view.minPitch;
								CAMERA_UNLOCK_DATA.radius = viewer.scene.view.radius;
								CAMERA_UNLOCK_DATA.pitch = viewer.scene.view.pitch;
								CAMERA_UNLOCK_DATA.focusPoint = controls.focusPoint;
								VIDEO[x].LockCamera = true;
								playVideo(x);
								userFeedbackPopup("Starting video");
							}
						}	
					}
				}
			}
		}

		//MOVE BACK TO "WORLD VIEW"
		var controls = viewer.getControls(viewer.scene.view.navigationMode);
		function ReturnToWorldView() {
			if (WORLD_STATE == IN_ENVIRONMENT) {
	            setState(IS_TRANSITIONING_TO_WORLDVIEW);
				viewer.scene.view.pitch = -0.7853981633974672;

				viewer.fitToScreen(1, 600);

				DOLLY_COUNTER = [0,0];

				userFeedbackPopup("Exiting environment");

				for (var i = 0; i < VIDEO.length; i++) {
					try { viewer.scene.scene.traverse((node) => { 
						if (node.uuid == VIDEO[i].MarkerUUID) {
		            		new TWEEN.Tween(node.material).to({opacity: 0}, 500).onComplete(function(){node.visible = false;}).start();
						}
		            }); } catch { }
				}

				$(".annotation").fadeIn(600, "swing", function() { 
					setState(IN_WORLDVIEW); 
					controls.worldViewCameraConfig = true;
				});
			}
		}

		//CHANGE STATE
		function setState(newState, shouldFadeOut = true) {
			WORLD_STATE = newState;

			if (WORLD_STATE == IN_ENVIRONMENT) {
				$(".OnlyInEnvironment").fadeIn(500);
			}
			else
			{
				if (shouldFadeOut) {
					$(".OnlyInEnvironment").fadeOut(500);
				}
				else
				{
					$(".OnlyInEnvironment").hide();
				}
			}

			if (WORLD_STATE == IS_TRACKING_VIDEO) {
				$(".OnlyInVideo").fadeIn(500);
			}
			else
			{
				if (shouldFadeOut) {
					$(".OnlyInVideo").fadeOut(500);
				}
				else
				{
					$(".OnlyInVideo").hide();
				}
			}
		}

		//SHOW USER FEEDBACK 
		function userFeedbackPopup(text) {
			$(".ARTSTATION_UserFeedback").hide();
			$(".ARTSTATION_UserFeedback").text(text);
			$(".ARTSTATION_UserFeedback").fadeIn(500).delay(1000).fadeOut(500);
		}

		//PLAY VIDEO
		function playVideo(video_id, reset=true) {
			var video_player = document.getElementById(VIDEO[video_id].ElementID); 
    		if (reset) {
    			try { viewer.scene.scene.traverse((node) => { 
    				if (node.uuid == VIDEO[video_id].UUID) {
		    			var new_position = new THREE.Vector3(
		                    VIDEO[video_id].PositionArray[0][0], 
		                    VIDEO[video_id].PositionArray[0][1], 
		                    VIDEO[video_id].PositionArray[0][3]);
		                var coords = ConvertToUTM(new_position.x, new_position.y);
		                var VIDEO_NEW_POSITION = new THREE.Vector3(coords[0], coords[1], parseFloat(new_position.z) + 25 + LOCATION[VIDEO[video_id].LocationDataIndex].Z_Offset);

		        		node.position.x = VIDEO_NEW_POSITION.x;
		        		node.position.y = VIDEO_NEW_POSITION.y;
		        		node.position.z = VIDEO_NEW_POSITION.z;
    				}
        		}); } catch { }
    			video_player.currentTime = 0;
    		}
    		video_player.play(); 
    		var marker_object = null;
    		var video_object = null;
    		try { viewer.scene.scene.traverse((node) => { 
    			if (node.uuid == VIDEO[video_id].MarkerUUID) { 
    				marker_object = node;
    			} 
    			if (node.uuid == VIDEO[video_id].UUID) { 
    				video_object = node;
    			} 
    		});} catch { }
		    var MARKER_TWEEN = new TWEEN.Tween(marker_object.material).to({opacity: 0}, 500);
		    MARKER_TWEEN.onComplete(function(){
		    	marker_object.visible = false;
		    	video_object.visible = true;
            	new TWEEN.Tween(video_object.material).to({opacity: 1}, 500).start();
		    });
		    MARKER_TWEEN.start();
		}

		//STOP VIDEO
		function stopVideo(video_id) {
			var video_player = document.getElementById(VIDEO[video_id].ElementID); 
			video_player.pause();
			video_player.currentTime = 0;
    		var marker_object = null;
    		var video_object = null;
    		try { viewer.scene.scene.traverse((node) => { 
    			if (node.uuid == VIDEO[video_id].MarkerUUID) { 
    				marker_object = node;
    			} 
    			if (node.uuid == VIDEO[video_id].UUID) { 
    				video_object = node;
    			} 
    		}); } catch { }
		    var VIDEO_TWEEN = new TWEEN.Tween(video_object.material).to({opacity: 0}, 500);
		    VIDEO_TWEEN.onComplete(function(){
		    	video_object.visible = false;
		    	marker_object.visible = true;
            	new TWEEN.Tween(marker_object.material).to({opacity: 1}, 500).start();
		    });
		    VIDEO_TWEEN.start();
		}

		//PAUSE VIDEO
		function pauseVideo(video_id) {
			var video_player = document.getElementById(VIDEO[video_id].ElementID); 
			video_player.pause();
		}

		//PLAY CURRENT VIDEO
		function playCurrentVideo() {
			FOCUSSED_VIDEO_STATE = REQUESTED_PLAY;
			for (var i = 0; i < VIDEO.length; i++) {
				if (VIDEO[i].LockCamera == true) {
					playVideo(i, false);
				}
			}
			userFeedbackPopup("Playing video");
		}

		//PAUSE CURRENT VIDEO
		function pauseCurrentVideo() {
			FOCUSSED_VIDEO_STATE = REQUESTED_PAUSE;
			for (var i = 0; i < VIDEO.length; i++) {
				if (VIDEO[i].LockCamera == true) {
					pauseVideo(i);
				}
			}
			userFeedbackPopup("Paused video");
		}

		//EXIT CURRENT VIDEO
		function exitCurrentVideo() {
			FOCUSSED_VIDEO_STATE = REQUESTED_STOP;
			for (var i = 0; i < VIDEO.length; i++) {
				if (VIDEO[i].LockCamera == true) {
					var controls = viewer.getControls(viewer.scene.view.navigationMode);
					setState(IS_TRANSITIONING_TO_VIDEO);
					controls.isTransitioning = true;
					VIDEO[i].LockCamera = false;
				}
			}
			userFeedbackPopup("Closed video");
		}

		//DOLLY ZOOM IN
		var DOLLY_ZOOM_IN = null;
		function DollyZoomIn() {
			if (WORLD_STATE == IN_ENVIRONMENT) {
				DOLLY_ZOOM_IN = setInterval(function(){
					if (DOLLY_COUNTER[0] <= 50) {
						DOLLY_COUNTER[0]++;
						DOLLY_COUNTER[1]--;
						var controls = viewer.getControls(viewer.scene.view.navigationMode);
						controls.dollyCamera(0.4);
					}
				}, 50);
			}
		}

		//DOLLY ZOOM OUT
		var DOLLY_ZOOM_OUT = null;
		function DollyZoomOut() {
			if (WORLD_STATE == IN_ENVIRONMENT) {
				DOLLY_ZOOM_OUT = setInterval(function(){
					if (DOLLY_COUNTER[1] <= 15) {
						DOLLY_COUNTER[0]--;
						DOLLY_COUNTER[1]++;
						var controls = viewer.getControls(viewer.scene.view.navigationMode);
						controls.dollyCamera(-0.4);
					}
				}, 50);
			}
		}

		//STOP DOLLY ZOOM
		function StopDollyZoom() {
			clearInterval(DOLLY_ZOOM_IN);
			clearInterval(DOLLY_ZOOM_OUT);
		}
	</script>
</body>
</html>