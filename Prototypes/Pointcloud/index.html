<html>
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>ARTSTATION Pointcloud Test</title>

	<link rel="stylesheet" type="text/css" href="SCRIPTS/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="SCRIPTS/jquery/jquery-3.1.1.min.js"></script>
	<script src="SCRIPTS/spectrum/spectrum.js"></script>
	<script src="SCRIPTS/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="SCRIPTS/jquery-ui/jquery-ui.min.js"></script>
	<script src="SCRIPTS/three.js/build/three.js"></script>
	<script src="SCRIPTS/other/BinaryHeap.js"></script>
	<script src="SCRIPTS/tween/tween.min.js"></script>
	<script src="SCRIPTS/d3/d3.js"></script>
	<script src="SCRIPTS/proj4/proj4.js"></script>
	<script src="SCRIPTS/openlayers3/ol.js"></script>
	<script src="SCRIPTS/i18next/i18next.js"></script>
	<script src="SCRIPTS/jstree/jstree.js"></script>
	<script src="SCRIPTS/potree/potree.js"></script>
	<script src="SCRIPTS/plasio/js/laslaz.js"></script>
	<!--<script src="SCRIPTS/ARTSTATION/main.js"></script>-->

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<!--<div id="potree_sidebar_container"> </div>-->
	</div>	

	<script>
		//DEFINE STATES
		var IN_WORLDVIEW = 0;
		var IN_ENVIRONMENT = 1;
		var STATE = IN_WORLDVIEW;

		//DEFINE POTREE VIEWER
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		//CONFIGURE VIEWER
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1*1000*1000);
		viewer.setDescription("CONTROLS: LMB - ENTER ENV & PAN // RMB - DRAG // ENTER - EXIT ENV");
		viewer.setEDLEnabled(true);
		viewer.setEDLRadius(1.5);
		viewer.setEDLStrength(0.1);
		viewer.setBackground("gradient"); //TODO: Map background, not gradient.
		viewer.loadSettingsFromURL();
		viewer.useHQ = true;

		/*
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
		});
		*/

		//LOAD FIELD
		loadLocation("field");

		//LOAD ST THOMAS HEAD
		loadLocation("st_thomas_head");

		//LOAD VIDEO TEST
		createVideo("field", "edited");

		//SET TO "WORLD VIEW"
		viewer.setView("U");


		//------------------------------------

		//LOAD LOCATION POINTCLOUD INTO VIEWER
		function loadLocation(locationName) {
		        Potree.loadPointCloud("ASSETS/POINTCLOUDS/"+locationName+"/cloud.js", locationName, e => {
		                let pointcloud = e.pointcloud;
		                let material = pointcloud.material;
		                viewer.scene.addPointCloud(pointcloud);
		                material.pointColorType = Potree.PointColorType.RGB;
		                material.size = 1;
		                material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
		                material.shape = Potree.PointShape.CIRCLE;
		                viewer.fitToScreen();
		        });
		}

		//CREATE A VIDEO IN WORLD
		function createVideo(location, videoName) {
		    //CREATE VIDEO ELEMENT
		    var video_element = document.createElement("video");
		    video_element.src = "ASSETS/VIDEOS/"+location+"/"+videoName+".mp4";
		    video_element.id = location+"_"+videoName;
		    video_element.autoplay = true;
		    video_element.loop = true;
		    video_element.volume = 0;
		    video_element.muted = true;
		    document.body.appendChild(video_element);

		    //CREATE VIDEO MESH
		    var video_plane = new THREE.PlaneGeometry(60, 34, 1, 1);
		    var video_elem = document.getElementById(location+"_"+videoName);
		    var video_texture = new THREE.VideoTexture(video_elem);
		    video_texture.minFilter = THREE.LinearFilter;
		    video_texture.magFilter = THREE.LinearFilter;
		    video_texture.format = THREE.RGBFormat;
		    var video_material = new THREE.MeshLambertMaterial( { color: 0xffffff, map: video_texture } );
		    var video_plane_mesh = new THREE.Mesh(video_plane, video_material);
		    video_plane_mesh.material.side = THREE.DoubleSide;
		    video_plane_mesh.name = "ARTSTATION_VideoPlane";
		    video_plane_mesh.position.x = 512635;
		    video_plane_mesh.position.y = 5694955;
		    video_plane_mesh.position.z = -85;
		    video_plane_mesh.rotation.y = Math.PI / 2;
		    video_plane_mesh.rotation.z = Math.PI / 2;
		    viewer.scene.scene.add(video_plane_mesh);
		}

		//MOVE TO LOCATION ON CLICK
		var mouse = new THREE.Vector2();
		var controls = viewer.getControls(viewer.scene.view.navigationMode);
		$(document).on("click",function(event) {
			if (STATE == IN_WORLDVIEW) {
		        mouse.x = event.clientX;
		        mouse.y = event.clientY;
				controls.zoomToLocation(mouse);
				if (controls.didClickEnvironment) {
					setState(IN_ENVIRONMENT);
				}
			}
		});

		//MOVE BACK TO "WORLD VIEW" ON PRESS OF KEY (ENTER)
		$(document).keypress(function(e) {
			if (STATE == IN_ENVIRONMENT) {
			    var keycode = (event.keyCode ? event.keyCode : event.which);
			    if(keycode == '13'){
		            setState(IN_WORLDVIEW);
			    }
			}
		});

		//CHANGE STATE
		function setState(newState) {
			STATE = newState;
			console.log("DEBUG: Changing state to " + newState);

			if (newState == IN_WORLDVIEW) {
				viewer.fitToScreen();
				viewer.setView("U");
			}
		}
	</script>
</body>
</html>