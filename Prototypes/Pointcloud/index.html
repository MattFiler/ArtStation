<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>ARTSTATION Pointcloud Test</title>

	<link rel="stylesheet" type="text/css" href="SCRIPTS/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/jstree/themes/mixed/style.css">
	<link rel="stylesheet" type="text/css" href="SCRIPTS/Cesium/Widgets/CesiumWidget/CesiumWidget.css">
</head>

<body>
	<script src="SCRIPTS/jquery/jquery-3.1.1.min.js"></script>
	<script src="SCRIPTS/spectrum/spectrum.js"></script>
	<script src="SCRIPTS/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="SCRIPTS/jquery-ui/jquery-ui.min.js"></script>
	<script src="SCRIPTS/three.js/build/three.js"></script>
	<script src="SCRIPTS/other/BinaryHeap.js"></script>
	<script src="SCRIPTS/tween/tween.min.js"></script>
	<script src="SCRIPTS/d3/d3.js"></script>
	<script src="SCRIPTS/proj4/proj4.js"></script>
	<script src="SCRIPTS/openlayers3/ol.js"></script>
	<script src="SCRIPTS/i18next/i18next.js"></script>
	<script src="SCRIPTS/jstree/jstree.js"></script>
	<script src="SCRIPTS/potree/potree.js"></script>
	<script src="SCRIPTS/plasio/js/laslaz.js"></script>
	<script src="SCRIPTS/Cesium/Cesium.js"></script>
	<script src="SCRIPTS/taylorc/geoutm.js"></script>
	<!--<script src="SCRIPTS/ARTSTATION/main.js"></script>-->

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area">
			<div id="cesiumContainer" style="position: absolute; width: 100%; height: 100%; background-color:green"></div>			
		</div>
		<!--<div id="potree_sidebar_container"> </div>-->
	</div>	

	<script>
		//DEFINE DATA ARRAYS
		var VIDEO = [];
		var LOCATION = [];

		//DEFINE STATES
		var IN_WORLDVIEW = 0;
		var IN_ENVIRONMENT = 1;
		var STATE = IN_WORLDVIEW;

		//DEFINE POTREE VIEWER
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"), {
			useDefaultRenderLoop: false
		});

		//CONFIGURE POTREE VIEWER
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1*1000*1000);
		viewer.setDescription("CONTROLS: LMB - ENTER ENV & PAN // RMB - DRAG // ENTER - EXIT ENV");
		viewer.setEDLEnabled(true);
		viewer.setEDLRadius(1.5);
		viewer.setEDLStrength(0.1);
		viewer.setBackground(null); 
		viewer.loadSettingsFromURL();
		viewer.useHQ = true;

		//DEFINE CESIUM VIEWER
		window.cesiumViewer = new Cesium.Viewer('cesiumContainer', {
			useDefaultRenderLoop: false,
			animation: false,
			baseLayerPicker : false,
			fullscreenButton: false, 
			geocoder: false,
			homeButton: false,
			infoBox: false,
			sceneModePicker: false,
			selectionIndicator: false,
			timeline: false,
			navigationHelpButton: false,
			imageryProvider : Cesium.BingMapsImageryProvider({url : '//dev.virtualearth.net'}),
			terrainShadows: Cesium.ShadowMode.DISABLED,
		});

		//CONFIGURE CESIUM VIEWER
		let cp = new Cesium.Cartesian3(4303414.154026048, 552161.235598733, 4660771.704035539);
		cesiumViewer.camera.setView({
			destination : cp,
			orientation: {
				heading : 10, 
				pitch : -Cesium.Math.PI_OVER_TWO * 0.5, 
				roll : 0.0 
			}
		});

		/*
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
		});
		*/

		//LOAD FIELD
		loadLocation("field");
		createVideo("field", "edited");

		//LOAD ST THOMAS HEAD
		loadLocation("st_thomas_head");
		createVideo("st_thomas_head", "DJI_0023");

		//SET TO "WORLD VIEW"
		viewer.setView("U");


		//------------------------------------

		//RENDER LOOP
		function loop(timestamp){
			requestAnimationFrame(loop);
			viewer.update(viewer.clock.getDelta(), timestamp);
			viewer.render();
			if(window.toMap !== undefined){
				{
					let camera = viewer.scene.getActiveCamera();

					let pPos = new THREE.Vector3(0, 0, 0).applyMatrix4(camera.matrixWorld);
					let pRight = new THREE.Vector3(600, 0, 0).applyMatrix4(camera.matrixWorld);
					let pUp = new THREE.Vector3(0, 600, 0).applyMatrix4(camera.matrixWorld);
					let pTarget = viewer.scene.view.getPivot();

					let toCes = (pos) => {
						let xy = [pos.x, pos.y];
						let height = pos.z;
						let deg = toMap.forward(xy);
						let cPos = Cesium.Cartesian3.fromDegrees(...deg, height);

						return cPos;
					};

					let cPos = toCes(pPos);
					let cUpTarget = toCes(pUp);
					let cTarget = toCes(pTarget);

					let cDir = Cesium.Cartesian3.subtract(cTarget, cPos, new Cesium.Cartesian3());
					let cUp = Cesium.Cartesian3.subtract(cUpTarget, cPos, new Cesium.Cartesian3());

					cDir = Cesium.Cartesian3.normalize(cDir, new Cesium.Cartesian3());
					cUp = Cesium.Cartesian3.normalize(cUp, new Cesium.Cartesian3());

					cesiumViewer.camera.setView({
						destination : cPos,
						orientation : {
							direction : cDir,
							up : cUp
						}
					});
				}

				let aspect = viewer.scene.getActiveCamera().aspect;
				if(aspect < 1){
					let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
					cesiumViewer.camera.frustum.fov = fovy;
				}else{
					let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
					let fovx = Math.atan(Math.tan(0.5 * fovy) * aspect) * 2
					cesiumViewer.camera.frustum.fov = fovx;
				}
			}
			cesiumViewer.render();
		}
		requestAnimationFrame(loop);

		//LOAD LOCATION POINTCLOUD INTO VIEWER
		function loadLocation(locationName) {
		        Potree.loadPointCloud("ASSETS/POINTCLOUDS/"+locationName+"/cloud.js", locationName, e => {
		                let pointcloud = e.pointcloud;
		                let material = pointcloud.material;

		                pointcloud.position.z = 0;

		                viewer.scene.addPointCloud(pointcloud);
		                material.pointColorType = Potree.PointColorType.RGB;
		                material.size = 1;
		                material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
		                material.shape = Potree.PointShape.CIRCLE;
		                viewer.fitToScreen();

					    var location_data = {
					        Name: locationName,
					        UUID: e.pointcloud.uuid
					    };
					    LOCATION.push(location_data);

						Potree.measureTimings = true;
						
						//TODO: Zone may need to be calculated per-location in future depending on the scale of the application, geoutm.js can do this. For now, we're fine with 30.
						let pointcloudProjection = "+proj=utm +zone=30 +ellps=GRS80 +datum=NAD83 +units=m +no_defs";
						let mapProjection = proj4.defs("WGS84");

						window.toMap = proj4(pointcloudProjection, mapProjection);
						window.toScene = proj4(mapProjection, pointcloudProjection);
						
						{
							let bb = viewer.getBoundingBox();

							let minWGS84 = proj4(pointcloudProjection, mapProjection, bb.min.toArray());
							let maxWGS84 = proj4(pointcloudProjection, mapProjection, bb.max.toArray());
						}
		        });
		}

		//CREATE A VIDEO IN WORLD
		function createVideo(location, videoName) {
		    //CREATE VIDEO ELEMENT
		    var video_element = document.createElement("video");
		    video_element.src = "ASSETS/VIDEOS/"+location+"/"+videoName+".mp4";
		    video_element.id = location+"_"+videoName;
		    video_element.autoplay = false;
		    video_element.loop = true;
		    video_element.volume = 0;
		    video_element.muted = true;
		    document.body.appendChild(video_element);

		    //CREATE VIDEO MESH
		    var video_plane = new THREE.PlaneGeometry(20, 12, 1, 1);
		    var video_elem = document.getElementById(location+"_"+videoName);
		    var video_texture = new THREE.VideoTexture(video_elem);
		    video_texture.minFilter = THREE.LinearFilter;
		    video_texture.magFilter = THREE.LinearFilter;
		    video_texture.format = THREE.RGBFormat;
		    var video_material = new THREE.MeshLambertMaterial( { color: 0xffffff, map: video_texture } );
		    var video_plane_mesh = new THREE.Mesh(video_plane, video_material);
		    video_plane_mesh.material.side = THREE.DoubleSide;
		    video_plane_mesh.name = "ARTSTATION_VideoPlane";
		    video_plane_mesh.position.x = 512635;
		    video_plane_mesh.position.y = 5694955;
		    video_plane_mesh.position.z = -85;
		    video_plane_mesh.rotation.y = Math.PI / 2;
		    video_plane_mesh.rotation.z = Math.PI / 2;
		    video_plane_mesh.visible = false;
		    viewer.scene.scene.add(video_plane_mesh);

		    //GET VIDEO POSITION DATA
		    var video_position_data = [];
		    var video_position_data_path = "API/gps_parser.php?location=" + location + "&srt=" + videoName; //REMOTE
		    //var video_position_data_path = "API/gps_parser.json"; //LOCAL
		    $.getJSON(video_position_data_path, function(data) {
		        $.each(data, function(key, val) {
		            video_position_data.push(val);
		        });
		    });

		    //ADD VIDEO TO GLOBAL VIDEO ARRAY
		    var video_data = {
		        Name: videoName,
		        ElementID: location+"_"+videoName,
		        Location: location, 
		        UUID: video_plane_mesh.uuid,
		        PositionArray: video_position_data
		    };
		    VIDEO.push(video_data);
		    var video_index = VIDEO.length - 1;

		    //MOVE VIDEO FROM GPS
		    moveVideoFromGPS(video_index);
		}

		//MOVE VIDEO ON TIME UPDATE FROM GPS DATA
		function moveVideoFromGPS(video_index) {
		    var major_time_milestone = 0;
		    var previous_acted_milestone = -1;
		    var first_run = true;
		    $("#"+VIDEO[video_index].ElementID).on("timeupdate", function(event){
		        major_time_milestone = Math.floor(this.currentTime);
		        if (major_time_milestone != previous_acted_milestone) {
		            previous_acted_milestone = major_time_milestone;
		            try {
		                viewer.scene.scene.traverse((node) => {       
		                    if (node.uuid == VIDEO[video_index].UUID) {
		                        var new_position = new THREE.Vector3(
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][0], 
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][1], 
		                            VIDEO[video_index].PositionArray[major_time_milestone+1][3]);
		                        var coords = ConvertToUTM(new_position.x, new_position.y);
		                        var NEW_POSITION = new THREE.Vector3(coords[0], coords[1], parseFloat(new_position.z) + 25);

		                    	if (first_run) {
		                    		node.position.x = NEW_POSITION.x;
		                    		node.position.y = NEW_POSITION.y;
		                    		node.position.z = NEW_POSITION.z;
		                    		first_run = false;
		                    	} else {
		                        	var tween = new TWEEN.Tween(node.position).to(NEW_POSITION, 1000).start();
		                    	}
		                    }
		                });
		            } catch { }
		        }
		    });
		}

		//MOVE TO LOCATION ON CLICK
		var mouse = new THREE.Vector2();
		var controls = viewer.getControls(viewer.scene.view.navigationMode);
		$(document).on("click",function(event) {
			if (STATE == IN_WORLDVIEW) {
		        mouse.x = event.clientX;
		        mouse.y = event.clientY;
				controls.zoomToLocation(mouse);
				if (controls.didClickEnvironment) {
		        	controls.isEnabled = true;

					setState(IN_ENVIRONMENT);

					var clicked_location_name = "";
					for (var i = 0; i < LOCATION.length; i++) {
						if (LOCATION[i].UUID == controls.clickedEnvironmentUUID) {
							clicked_location_name = LOCATION[i].Name;
						}
					}
					for (var i = 0; i < VIDEO.length; i++) {
						if (VIDEO[i].Location == clicked_location_name) {
							playVideo(i);
						}
					}
				}
			}
		});

		//MOVE BACK TO "WORLD VIEW" ON PRESS OF KEY (ENTER)
		$(document).keypress(function(e) {
			if (STATE == IN_ENVIRONMENT) {
			    var keycode = (event.keyCode ? event.keyCode : event.which);
			    if(keycode == '13'){
		            setState(IN_WORLDVIEW);

					viewer.fitToScreen();
					viewer.setView("U");

					var controls = viewer.getControls(viewer.scene.view.navigationMode);
					controls.isEnabled = false;

					for (var i = 0; i < VIDEO.length; i++) {
						stopVideo(i);
					}
			    }
			}
		});

		//CHANGE STATE
		function setState(newState) {
			STATE = newState;
		}

		//PLAY VIDEO
		function playVideo(video_id) {
			var video_player = document.getElementById(VIDEO[video_id].ElementID); 
    		video_player.play(); 
    		try { viewer.scene.scene.traverse((node) => { if (node.uuid == VIDEO[video_id].UUID) { node.visible = true; } }); } catch { }
		}

		//STOP VIDEO
		function stopVideo(video_id) {
			var video_player = document.getElementById(VIDEO[video_id].ElementID); 
			video_player.pause();
			video_player.currentTime = 0;
    		try { viewer.scene.scene.traverse((node) => { if (node.uuid == VIDEO[video_id].UUID) { node.visible = false; } }); } catch { }
		}
	</script>
</body>
</html>